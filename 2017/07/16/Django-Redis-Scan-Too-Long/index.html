<!doctype html>



  


<html class="theme-next mist use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Django,Redis,Scan,Performance," />





  <link rel="alternate" href="/atom.xml" title="Alice && Bob" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1" />






<meta name="description" content="Recently I met an issue that one of our APIs of the online production servers is very slow due to redis scan.  From next graph generated by NewRelic, we found AVERAGE response time is 2930ms while red">
<meta name="keywords" content="Django,Redis,Scan,Performance">
<meta property="og:type" content="article">
<meta property="og:title" content="Redis Scan Too Slow in Django Application">
<meta property="og:url" content="https://morganwu277.github.io/2017/07/16/Django-Redis-Scan-Too-Long/index.html">
<meta property="og:site_name" content="Alice &amp;&amp; Bob">
<meta property="og:description" content="Recently I met an issue that one of our APIs of the online production servers is very slow due to redis scan.  From next graph generated by NewRelic, we found AVERAGE response time is 2930ms while red">
<meta property="og:image" content="https://morganwu277.github.io/2017/07/16/Django-Redis-Scan-Too-Long/redis-scan-slow.png">
<meta property="og:updated_time" content="2017-07-16T03:32:03.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Redis Scan Too Slow in Django Application">
<meta name="twitter:description" content="Recently I met an issue that one of our APIs of the online production servers is very slow due to redis scan.  From next graph generated by NewRelic, we found AVERAGE response time is 2930ms while red">
<meta name="twitter:image" content="https://morganwu277.github.io/2017/07/16/Django-Redis-Scan-Too-Long/redis-scan-slow.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":true},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://morganwu277.github.io/2017/07/16/Django-Redis-Scan-Too-Long/"/>





  <title>Redis Scan Too Slow in Django Application | Alice && Bob</title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  




<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-99580993-1', 'auto');
  ga('send', 'pageview');
</script>












  
  
    
  

  <div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Alice && Bob</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Alice && Bob</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            Search
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="Searching..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://morganwu277.github.io/2017/07/16/Django-Redis-Scan-Too-Long/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Morgan Wu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Alice && Bob">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Redis Scan Too Slow in Django Application</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-07-16T02:32:46-04:00">
                2017-07-16
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Database/" itemprop="url" rel="index">
                    <span itemprop="name">Database</span>
                  </a>
                </span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Database/NoSQL/" itemprop="url" rel="index">
                    <span itemprop="name">NoSQL</span>
                  </a>
                </span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Database/NoSQL/In-Memory/" itemprop="url" rel="index">
                    <span itemprop="name">In-Memory</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/07/16/Django-Redis-Scan-Too-Long/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2017/07/16/Django-Redis-Scan-Too-Long/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>Recently I met an issue that one of our APIs of the online production servers is very slow due to <code>redis scan</code>. </p>
<p>From next graph generated by NewRelic, we found AVERAGE <code>response time</code> is 2930ms while <code>redis scan</code> could take 2680ms, which is 2680/2930 = 91.4% portion of the total time. </p>
<center><img src="/2017/07/16/Django-Redis-Scan-Too-Long/redis-scan-slow.png" alt="Redis Scan Too Slow" title="Redis Scan Too Slow"></center>

<p>Why redis scan cost this much? From our local environment, we never noticed such huge performance issue. </p>
<a id="more"></a>
<h1 id="Locate-the-culprit">1. Locate the culprit</h1><h2 id="Phenomenon">1.1. Phenomenon</h2><p>After that I dug into the source code and found next code snippet in our Django Application and this is the only code of this API to access <code>redis</code>, so this must be the culprit of this issue. </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> django.core.cache <span class="keyword">import</span> cache</div><div class="line"></div><div class="line">// ...... more code <span class="keyword">is</span> ommitted here</div><div class="line"></div><div class="line">cache.delete_pattern(CACHE_KEY)</div></pre></td></tr></table></figure>
<p>From the above code, we could know that redis is treated as a cache server here.</p>
<p>So what does <code>delete_pattern</code> do on the earth? So I traced the code and in the end found next <code>delete_pattern</code> definition from <code>django_redis.client.default.DefaultClient#delete_pattern</code>.</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete_pattern</span><span class="params">(self, pattern, version=None, prefix=None, client=None)</span>:</span></div><div class="line">    <span class="string">"""</span></div><div class="line">    Remove all keys matching pattern.</div><div class="line">    """</div><div class="line"></div><div class="line">    <span class="keyword">if</span> client <span class="keyword">is</span> <span class="keyword">None</span>:</div><div class="line">        client = self.get_client(write=<span class="keyword">True</span>)</div><div class="line"></div><div class="line">    pattern = self.make_key(pattern, version=version, prefix=prefix)</div><div class="line">    <span class="keyword">try</span>:</div><div class="line">        count = <span class="number">0</span></div><div class="line">        <span class="keyword">for</span> key <span class="keyword">in</span> client.scan_iter(pattern): // please note here</div><div class="line">            client.delete(key)</div><div class="line">            count += <span class="number">1</span></div><div class="line">        <span class="keyword">return</span> count</div><div class="line">    <span class="keyword">except</span> _main_exceptions <span class="keyword">as</span> e:</div><div class="line">        <span class="keyword">raise</span> ConnectionInterrupted(connection=client, parent=e)</div></pre></td></tr></table></figure>
<p>The code calls <code>client.scan_iter(pattern)</code> to get next cursor and try to delete that key of the cursor. </p>
<h2 id="Redis-scan">1.2. Redis scan</h2><p>From the official site of <a href="https://redis.io/commands/scan" target="_blank" rel="external">redis scan</a>, we can combine <code>MATCH</code> and <code>COUNT</code> in the <code>SCAN</code> command.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">redis 127.0.0.1:6379&gt; scan 0 MATCH *11*</div><div class="line">1) <span class="string">"288"</span></div><div class="line">2) 1) <span class="string">"key:911"</span></div><div class="line">redis 127.0.0.1:6379&gt; scan 288 MATCH *11*</div><div class="line">1) <span class="string">"224"</span></div><div class="line">2) (empty list or <span class="built_in">set</span>)</div><div class="line">redis 127.0.0.1:6379&gt; scan 224 MATCH *11*</div><div class="line">1) <span class="string">"80"</span></div><div class="line">2) (empty list or <span class="built_in">set</span>)</div><div class="line">redis 127.0.0.1:6379&gt; scan 80 MATCH *11*</div><div class="line">1) <span class="string">"176"</span></div><div class="line">2) (empty list or <span class="built_in">set</span>)</div><div class="line">redis 127.0.0.1:6379&gt; scan 176 MATCH *11* COUNT 1000</div><div class="line">1) <span class="string">"0"</span></div><div class="line">2)  1) <span class="string">"key:611"</span></div><div class="line">    2) <span class="string">"key:711"</span></div><div class="line">    3) <span class="string">"key:118"</span></div><div class="line">    4) <span class="string">"key:117"</span></div><div class="line">    5) <span class="string">"key:311"</span></div><div class="line">    6) <span class="string">"key:112"</span></div><div class="line">    7) <span class="string">"key:111"</span></div><div class="line">    8) <span class="string">"key:110"</span></div><div class="line">    9) <span class="string">"key:113"</span></div><div class="line">   10) <span class="string">"key:211"</span></div><div class="line">   11) <span class="string">"key:411"</span></div><div class="line">   12) <span class="string">"key:115"</span></div><div class="line">   13) <span class="string">"key:116"</span></div><div class="line">   14) <span class="string">"key:114"</span></div><div class="line">   15) <span class="string">"key:119"</span></div><div class="line">   16) <span class="string">"key:811"</span></div><div class="line">   17) <span class="string">"key:511"</span></div><div class="line">   18) <span class="string">"key:11"</span></div><div class="line">redis 127.0.0.1:6379&gt;</div></pre></td></tr></table></figure></p>
<p>The above command returned me with a <code>0</code> means, in the first line of response, there is no more data to scan. If not <code>0</code>, the number is next cursor to be used to scan. </p>
<blockquote>
<p>It is important to note that the MATCH filter is applied <strong><code>after</code></strong> elements are retrieved from the collection, just before returning data to the client. </p>
</blockquote>
<p>This means, firstly it will retrieve the data, and then will use a filter to match the retrieved data.<br>Does this means there could be multiple back-and-forth between the client and server, and which will cost the huge latency of this redis scan? If that’s true, we just need an extra easy <code>COUNT</code> parameter. </p>
<h1 id="Validation-in-local-environment">2. Validation in local environment</h1><h2 id="KEYS-number">2.1. KEYS number</h2><p>How many keys are there in our online production redis server?<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">127.0.0.1:6379[10]&gt; INFO</div><div class="line"><span class="comment"># more code is ommitted here</span></div><div class="line">db10:keys=6986,expires=6986,avg_ttl=40118300</div></pre></td></tr></table></figure></p>
<p>From above code, we can know there are nearly 7000 keys in our server. </p>
<h2 id="Client-Server-latency">2.2. Client-Server latency</h2><p>I simply use the <code>ping</code> command to get the latency and it’s 3.5 ms. Due to classified cause, sensitive info is hidden.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">[xxx@xxxx.xxx.xxx.xxx ~]$ ping xxxx.com</div><div class="line">PING xxxx.com (xx.xx.xx.xx) 56(84) bytes of data.</div><div class="line">64 bytes from xxxx.com (xx.xx.xx.xx): icmp_seq=1 ttl=58 time=3.58 ms</div><div class="line">64 bytes from xxxx.com (xx.xx.xx.xx): icmp_seq=2 ttl=58 time=3.46 ms</div><div class="line">--- xxxx.com ping statistics ---</div><div class="line">2 packets transmitted, 2 received, 0% packet loss, time 3004ms</div><div class="line">rtt min/avg/max/mdev = 3.461/3.498/3.585/0.050 ms</div></pre></td></tr></table></figure></p>
<h2 id="Simulate-the-Network-Latency-Locally">2.3. Simulate the Network Latency Locally</h2><p>From this <a href="http://bencane.com/2012/07/16/tc-adding-simulated-network-latency-to-your-linux-server/" target="_blank" rel="external">post</a>, I successfully simulated the network latency.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">(venv) vagrant@localhost:~ $ sudo tc qdisc add dev lo root netem delay 2ms </div><div class="line">(venv) vagrant@localhost:~ $ ping 127.0.0.1</div><div class="line">PING 127.0.0.1 (127.0.0.1) 56(84) bytes of data.</div><div class="line">64 bytes from 127.0.0.1: icmp_seq=1 ttl=64 time=4.34 ms</div><div class="line">--- 127.0.0.1 ping statistics ---</div><div class="line">1 packets transmitted, 1 received, 0% packet loss, time 0ms</div><div class="line">rtt min/avg/max/mdev = 4.348/4.348/4.348/0.000 ms</div></pre></td></tr></table></figure></p>
<p>So I made the <code>lo</code> NIC as slow as around 4.3 ms. </p>
<h2 id="Measure-the-time-of-cleaning-the-cache-before-and-after-setting-the-delay">2.4. Measure the time of cleaning the cache before and after setting the delay</h2><p>Since this is a Django application, so I can use Django Shell to try to execute the clean cache statement, which as a result operate the local redis server.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">(venv) vagrant@localhost:~ $ time python manage.py shell -c <span class="string">'from django.core.cache import cache; cache.delete_pattern("view_cache:dispatch:123456789:category_slug:all")'</span></div><div class="line"></div><div class="line">real    0m8.404s</div><div class="line">user    0m0.944s</div><div class="line">sys     0m0.696s</div></pre></td></tr></table></figure></p>
<p>What if we don’t set the delay option, what’s would the timing metric be?<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">(venv) vagrant@lcoalhost:~ $ time python manage.py shell -c <span class="string">'from django.core.cache import cache; cache.delete("view_cache:dispatch:123456789:category_slug:all")'</span></div><div class="line"></div><div class="line">real    0m4.366s</div><div class="line">user    0m0.800s</div><div class="line">sys     0m0.648s</div></pre></td></tr></table></figure></p>
<p>From the above test, we can see that before and after will make a huge difference as large as 4 seconds !!! And this is under the network latency of 4.3 ms. If the network latency is around 3.5 ms, the total time of cleaning cache could be as large as 3 seconds, which is very close the above phenomenon!</p>
<p>Now, we can get a conclusion: network latency will influence too much on the <code>redis scan</code> performance. <code>SCAN</code> will call the redis multiple times back-and-forth, which in the end, cause a large <code>redis scan</code> time. </p>
<p>How to solve the problem? Use the <code>COUNT</code> parameter!</p>
<h1 id="Solve-the-problem">3. Solve the problem</h1><h2 id="Estimation-of-deleting-time-again">3.1. Estimation of deleting time again</h2><p>From the definition of <code>delete_pattern</code> method, we can see it just <code>scan_iter</code> the redis using the default <code>COUNT</code> which is 10. Let’s give an estimation here:</p>
<ol>
<li>The <code>Redis Scan</code> use a sequential scan with <code>COUNT</code> as 10, there will be 6986/10 = 700 times to scan. </li>
<li>Each scan costs at least 1 ping time, which is 3.5 ms.</li>
<li>In total, 3.5*700 = 2450 ms, which is close to the 2680 ms of the phenomenon above. Interesting.  </li>
</ol>
<p>From above estimation, we are more confident of our guess now, and using the <code>COUNT</code> must be the solution!</p>
<p>But the <code>delete_pattern</code> method provided by the default client doesn’t use <code>COUNT</code> parameter, so what I can do is to create a new Redis Client which is inherited from the default Client and override this <code>delete_pattern</code> method to use the <code>COUNT</code> parameter.</p>
<p>Here is my code:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> socket</div><div class="line"></div><div class="line"><span class="comment"># Compatibility with redis-py 2.10.x+</span></div><div class="line"><span class="keyword">from</span> redis.exceptions <span class="keyword">import</span> ConnectionError</div><div class="line"><span class="keyword">from</span> redis.exceptions <span class="keyword">import</span> ResponseError</div><div class="line"><span class="keyword">from</span> django_redis.exceptions <span class="keyword">import</span> ConnectionInterrupted, CompressorError</div><div class="line"><span class="keyword">from</span> django_redis.client <span class="keyword">import</span> DefaultClient</div><div class="line"></div><div class="line"><span class="keyword">try</span>:</div><div class="line">    <span class="keyword">from</span> redis.exceptions <span class="keyword">import</span> TimeoutError, ResponseError</div><div class="line">    _main_exceptions = (TimeoutError, ResponseError, ConnectionError, socket.timeout)</div><div class="line"><span class="keyword">except</span> ImportError:</div><div class="line">    _main_exceptions = (ConnectionError, socket.timeout)</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">CacheClient</span><span class="params">(DefaultClient)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">delete_pattern</span><span class="params">(self, pattern, itersize=None, version=None, prefix=None, client=None)</span>:</span></div><div class="line">        <span class="string">"""</span></div><div class="line">        Remove all keys matching pattern.</div><div class="line">        """</div><div class="line"></div><div class="line">        <span class="keyword">if</span> client <span class="keyword">is</span> <span class="keyword">None</span>:</div><div class="line">            client = self.get_client(write=<span class="keyword">True</span>)</div><div class="line"></div><div class="line">        pattern = self.make_key(pattern, version=version, prefix=prefix)</div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            count = <span class="number">0</span></div><div class="line">            <span class="keyword">for</span> key <span class="keyword">in</span> client.scan_iter(pattern, count=itersize): // have a itersize here</div><div class="line">                client.delete(key)</div><div class="line">                count += <span class="number">1</span></div><div class="line">            <span class="keyword">return</span> count</div><div class="line">        <span class="keyword">except</span> _main_exceptions <span class="keyword">as</span> e:</div><div class="line">            <span class="keyword">raise</span> ConnectionInterrupted(connection=client, parent=e)</div></pre></td></tr></table></figure></p>
<p>When I call the code, I make sure to pass the <code>itersize</code> very large, say, 10,000 to eliminate too many back-and-forth RPC calls. </p>
<h2 id="Enable-the-customized-redis-client-class">3.2. Enable the customized redis client class</h2><p>Of course we need to enable this client in our <code>settings/local.py</code><br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">CACHES = &#123;</div><div class="line">    'default': &#123;</div><div class="line">        'BACKEND': 'django_redis.cache.RedisCache',</div><div class="line">        # redis server</div><div class="line">        'LOCATION':</div><div class="line">        os.environ.get('NOJ_REDIS_CACHE_URL', 'redis://localhost:6379/10'),</div><div class="line">        'OPTIONS': &#123;</div><div class="line">            'PARSER_CLASS': 'redis.connection.HiredisParser',</div><div class="line">            'CLIENT_CLASS': 'common.cache_client.CacheClient' // enable the customized redis client class</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="Test-after-fixing">3.3. Test after fixing</h2><p>I added a <code>10000</code> after my <code>delete_pattern</code> call.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">(venv) vagrant@localhost:~ $ time python manage.py shell -c <span class="string">'from django.core.cache import cache; cache.delete_pattern("view_cache:dispatch:123456789:category_slug:all",10000)'</span> </div><div class="line"></div><div class="line">real    0m4.021s</div><div class="line">user    0m0.784s</div><div class="line">sys     0m0.612s</div></pre></td></tr></table></figure></p>
<p>The time now is very close to the time before setting the network latency, which means, <code>delete_pattern</code> won’t be a performance issue anymore, since it only has one RPC call now. </p>
<p>Cheers, bro!</p>
<h1 id="Conclusion">4. Conclusion</h1><ul>
<li>Don’t be afraid of the library source code, just dig into it.</li>
<li>Use <code>tc</code> command to simulate the network latency.</li>
<li><code>MATCH</code> in<code>Redis Scan</code> is to filter on top of the retrieved data. </li>
<li>Default <code>COUNT</code> of <code>Redis Scan</code> is 10. </li>
<li>Use <code>python manage.py shell</code> to execute ad-hoc test.</li>
<li>Use <code>ping</code> to get network latency. </li>
<li>Use <code>INFO</code> to get redis statistical information. </li>
</ul>
<hr>
<p><strong>References</strong></p>
<ul>
<li><a href="https://redis.io/commands/scan" target="_blank" rel="external">Redis Scan</a></li>
<li><a href="http://bencane.com/2012/07/16/tc-adding-simulated-network-latency-to-your-linux-server/" target="_blank" rel="external">tc: Adding simulated network latency to your Linux server</a></li>
</ul>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Django/" rel="tag"># Django</a>
          
            <a href="/tags/Redis/" rel="tag"># Redis</a>
          
            <a href="/tags/Scan/" rel="tag"># Scan</a>
          
            <a href="/tags/Performance/" rel="tag"># Performance</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/06/29/Debug-Ansible/" rel="next" title="Debug Ansible and Tiny Introduction of PlayBook">
                <i class="fa fa-chevron-left"></i> Debug Ansible and Tiny Introduction of PlayBook
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/07/16/工作の思考/" rel="prev" title="工作の思考">
                工作の思考 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
        <!-- Go to www.addthis.com/dashboard to customize your tools -->
<div class="addthis_inline_share_toolbox">
  <script type = "text/javascript" src = "//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-59378a9a24c914f0" async = "async" ></script>
</div>

      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            Overview
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="Morgan Wu" />
          <p class="site-author-name" itemprop="name">Morgan Wu</p>
           
              <p class="site-description motion-element" itemprop="description">此中有真意，欲辨已忘言。<br/> Just let it be. If it's meant to be, it will happen.</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">20</span>
                <span class="site-state-item-name">posts</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">32</span>
                <span class="site-state-item-name">categories</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">51</span>
                <span class="site-state-item-name">tags</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Locate-the-culprit"><span class="nav-text">1. Locate the culprit</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Phenomenon"><span class="nav-text">1.1. Phenomenon</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Redis-scan"><span class="nav-text">1.2. Redis scan</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Validation-in-local-environment"><span class="nav-text">2. Validation in local environment</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#KEYS-number"><span class="nav-text">2.1. KEYS number</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Client-Server-latency"><span class="nav-text">2.2. Client-Server latency</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Simulate-the-Network-Latency-Locally"><span class="nav-text">2.3. Simulate the Network Latency Locally</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Measure-the-time-of-cleaning-the-cache-before-and-after-setting-the-delay"><span class="nav-text">2.4. Measure the time of cleaning the cache before and after setting the delay</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Solve-the-problem"><span class="nav-text">3. Solve the problem</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Estimation-of-deleting-time-again"><span class="nav-text">3.1. Estimation of deleting time again</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Enable-the-customized-redis-client-class"><span class="nav-text">3.2. Enable the customized redis client class</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Test-after-fixing"><span class="nav-text">3.3. Test after fixing</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Conclusion"><span class="nav-text">4. Conclusion</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Morgan Wu</span>
</div>


<div class="powered-by">
  Powered by <a class="theme-link" href="https://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  

    
      <script id="dsq-count-scr" src="https://morganwu277-github-io.disqus.com/count.js" async></script>
    

    
      <script type="text/javascript">
        var disqus_config = function () {
          this.page.url = 'https://morganwu277.github.io/2017/07/16/Django-Redis-Scan-Too-Long/';
          this.page.identifier = '2017/07/16/Django-Redis-Scan-Too-Long/';
          this.page.title = 'Redis Scan Too Slow in Django Application';
        };
        var d = document, s = d.createElement('script');
        s.src = 'https://morganwu277-github-io.disqus.com/embed.js';
        s.setAttribute('data-timestamp', '' + +new Date());
        (d.head || d.body).appendChild(s);
      </script>
    

  




	





  





  








  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (search_path.endsWith("json")) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  

  

</body>
</html>
